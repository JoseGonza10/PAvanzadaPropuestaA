@model SiteAsientos.Models.Order
@{
    ViewData["Title"] = "Crear Orden";
    Layout = "~/Views/Shared/_Layout2.cshtml";
}

<div class="content">
    <div class="container-fluid">

        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success">@TempData["SuccessMessage"]</div>
        }

        <div class="row">
            <div class="col-12">
                <div class="card">

                    <div class="card-header card-header-primary">
                        <h4 class="card-title">Nueva Orden</h4>
                        <p class="card-category">Complete la información de la orden</p>
                    </div>

                    <div class="card-body">
                        <form asp-action="Create" method="post">

                            <input type="hidden" asp-for="Order_Id" />
                            <input type="hidden" asp-for="Order_DesignId" />
                            <input type="hidden" asp-for="Order_Code" />

                            <div class="form-group">
                                <label class="bmd-label-floating">Cliente (Nombre Completo)</label>
                                <input asp-for="Order_CustomerName" class="form-control" />
                                <span asp-validation-for="Order_CustomerName" class="text-danger"></span>
                            </div>

                            <div class="form-group">
                                <label class="bmd-label-floating">Cédula</label>
                                <input asp-for="Order_CustomerId" class="form-control" />
                                <span asp-validation-for="Order_CustomerId" class="text-danger"></span>
                            </div>

                            <div class="form-group">
                                <label class="bmd-label-floating">Teléfono</label>
                                <input asp-for="Order_CustomerPhone" class="form-control" />
                                <span asp-validation-for="Order_CustomerPhone" class="text-danger"></span>
                            </div>

                            <div class="form-group">
                                <label class="bmd-label-floating">Correo Electrónico</label>
                                <input asp-for="Order_CustomerEmail" class="form-control" />
                                <span asp-validation-for="Order_CustomerEmail" class="text-danger"></span>
                            </div>

                            <!-- Información del vehículo -->
                            <div class="form-group">
                                <label>Marca del Vehículo</label>
                                <select class="form-control" id="CarBrand" name="CarBrand">
                                    <option value="">-- Seleccione --</option>
                                    @foreach (var brand in (List<string>)ViewBag.CarBrands)
                                    {
                                        <option value="@brand">@brand</option>
                                    }
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Modelo del Vehículo</label>
                                <select class="form-control" id="CarModel" name="CarModel">
                                    <option value="">-- Seleccione la marca primero --</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="bmd-label-floating">Año del Modelo</label>
                                <input asp-for="Order_ModelYear" class="form-control" />
                                <span asp-validation-for="Order_ModelYear" class="text-danger"></span>
                            </div>

                            <div class="form-group">
                                <label class="bmd-label-floating">Número de Placa</label>
                                <input asp-for="Order_CustomerPlateNumber" class="form-control" />
                                <span asp-validation-for="Order_CustomerPlateNumber" class="text-danger"></span>
                            </div>

                            <!-- Selección de material -->
                            <div class="form-group">
                                <label>Material</label>
                                <select asp-for="Order_DesignId" class="form-control" name="MaterialId">
                                    <option value="">-- Seleccione un material --</option>
                                    @foreach (var mat in (IEnumerable<SiteAsientos.Models.Material>)ViewBag.Materials)
                                    {
                                        <option value="@mat.Material_Id">@mat.Material_Name</option>
                                    }
                                </select>
                            </div>

                            <!-- Selección del tipo de servicio -->
                            <div class="form-group">
                                <label>Tipo de Servicio</label>
                                <select class="form-control" id="ServiceType" name="ServiceType">
                                    <option value="Completo">Completo</option>
                                    <option value="Solo asientos delanteros">Solo asientos delanteros</option>
                                    <option value="Solo asientos traseros">Solo asientos traseros</option>
                                    <option value="Full extras">Full extras</option>
                                </select>
                            </div>

                            <!-- Mostrar precio calculado -->
                            <div class="form-group">
                                <label>Precio Total (Calculado)</label>
                                <input type="text" id="CalculatedPrice" class="form-control" readonly />
                            </div>

                            <!-- Fecha y hora de la cita -->
                            <div class="form-group">
                                <label>Fecha de la Cita</label>
                                <input type="date" class="form-control" name="AppointmentDate" required />
                            </div>
                            <div class="form-group">
                                <label>Hora de la Cita</label>
                                <input type="time" class="form-control" name="AppointmentTime" required />
                            </div>
                            <span asp-validation-for="Order_Date" class="text-danger"></span>

                            <!-- Monto abonado -->
                            <div class="form-group">
                                <label>Monto Abonado</label>
                                <input type="number" step="0.01" class="form-control" name="MontoAbonado" required />
                            </div>
                            <span class="text-danger" data-valmsg-for="MontoAbonado" data-valmsg-replace="true"></span>

                            <button type="submit" class="btn btn-primary btn-round">Guardar Orden</button>
                            <a class="btn btn-secondary btn-round" href="@Url.Action("Index","Home")">Cancelar</a>
                        </form>
                    </div>

                </div>
            </div>
        </div>

    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        var basePrice = parseFloat('@ViewBag.BasePrice');
        var carModels = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.CarModels));

        // Cambio de marca => Actualizar modelos
        document.getElementById('CarBrand').addEventListener('change', function() {
            var brand = this.value;
            var modelSelect = document.getElementById('CarModel');
            modelSelect.innerHTML = '<option value="">-- Seleccione --</option>';
            if (carModels[brand]) {
                carModels[brand].forEach(function(m) {
                    var opt = document.createElement('option');
                    opt.value = m;
                    opt.textContent = m;
                    modelSelect.appendChild(opt);
                });
            }
        });

        // Calcular precio en tiempo real
        var serviceTypeSelect = document.getElementById('ServiceType');
        var calculatedPriceInput = document.getElementById('CalculatedPrice');

        function calculatePrice() {
            var serviceType = serviceTypeSelect.value;
            var finalPrice = basePrice;
            switch (serviceType) {
                case "Solo asientos delanteros":
                    finalPrice = basePrice * 0.65;
                    break;
                case "Solo asientos traseros":
                    finalPrice = basePrice * 0.45;
                    break;
                case "Full extras":
                    finalPrice = basePrice * 1.35;
                    break;
                default:
                    finalPrice = basePrice;
            }
            calculatedPriceInput.value = finalPrice.toFixed(2);
        }

        serviceTypeSelect.addEventListener('change', calculatePrice);
        // Calcular el precio inicialmente
        calculatePrice();
    </script>
}
